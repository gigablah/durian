<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Durian : A PHP 5.5 microframework based on generator-style middleware." />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Durian</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/gigablah/durian">View on GitHub</a>

          <h1 id="project_title">Durian</h1>
          <h2 id="project_tagline">A PHP 5.5 microframework based on generator-style middleware.</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/gigablah/durian/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/gigablah/durian/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="durian" class="anchor" href="#durian"><span class="octicon octicon-link"></span></a>Durian</h1>

<p><a href="https://travis-ci.org/gigablah/durian"><img src="https://travis-ci.org/gigablah/durian.png?branch=master" alt="Build Status"></a> <a href="https://coveralls.io/r/gigablah/durian"><img src="https://coveralls.io/repos/gigablah/durian/badge.png" alt="Coverage Status"></a></p>

<p>Durian is a PHP microframework that utilizes the newest features of PHP 5.5 together with lightweight library components to create an accessible, compact framework with performant routing and flexible generator-style middleware.</p>

<h2>
<a name="why" class="anchor" href="#why"><span class="octicon octicon-link"></span></a>Why?</h2>

<p>Because I can.</p>

<h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Use <a href="http://getcomposer.org">Composer</a> to install the gigablah/durian library by adding it to your <code>composer.json</code>.</p>

<div class="highlight highlight-json"><pre><span class="p">{</span>
    <span class="nt">"require"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"gigablah/durian"</span><span class="p">:</span> <span class="s2">"~0.1"</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h2>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h2>

<div class="highlight highlight-php"><pre><span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Durian\Application</span><span class="p">();</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/hello/{name}'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'Hello '</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
<span class="p">});</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">();</span>
</pre></div>

<p>Nothing special there. The <code>Application</code> container is based on <a href="http://pimple.sensiolabs.org">Pimple</a> and inherits its functions for defining lazy loading services. We also make use of the Symfony2 <code>Request</code> object so you have access to request headers, parameters and cookies. But since this is a PHP 5.5 microframework, it has been tailored to take advantage of shiny new <a href="http://www.php.net/manual/en/language.generators.overview.php">generator functions</a>. We'll explore that starting with the core of our application: the handler stack.</p>

<h2>
<a name="handlers" class="anchor" href="#handlers"><span class="octicon octicon-link"></span></a>Handlers</h2>

<p>When the application is run, the <code>Request</code> object is inserted into a <code>Context</code> object which is passed through a series of handler functions. They may read information from the request attributes, insert information into the context, create a <code>Response</code>, throw an exception and so on. Some of these functions may themselves comprise a series of functions, which are executed in the same manner as the main stack. If there are any generator functions encountered along the way, they are revisited in reverse order after the end of the stack is reached. This entire mechanism is encapsulated in the <code>Handler</code> class.</p>

<p>All handlers boil down to an array of callables or generator functions with an optional test function. They can be defined using <code>Application::handler</code>:</p>

<div class="highlight highlight-php"><pre><span class="nv">$responseTimeHandler</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">handler</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// this executes before the rest of the stack</span>
    <span class="nv">$time</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="nx">yield</span><span class="p">;</span>
    <span class="c1">// this executes after the rest of the stack</span>
    <span class="nv">$time</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$time</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">headers</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'X-Response-Time'</span><span class="p">,</span> <span class="nv">$time</span><span class="p">);</span>
<span class="p">},</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// only execute for the master request in the debug environment</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">master</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nv">$app</span><span class="p">[</span><span class="s1">'debug'</span><span class="p">];</span>
<span class="p">});</span>
</pre></div>

<p>This returns a <code>Handler</code> object which can now be added to the front or back of the middleware stack:</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">before</span><span class="p">(</span><span class="nv">$responseTimeHandler</span><span class="p">);</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">after</span><span class="p">(</span><span class="nv">$someOtherHandler</span><span class="p">);</span>
</pre></div>

<p>You can modify the entire stack with <code>Application::handlers</code>. The second parameter determines whether to replace the whole stack (true by default).</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">([</span>
    <span class="nv">$responseTimeHandler</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">Durian\Middleware\RouterMiddleware</span><span class="p">(</span><span class="nv">$app</span><span class="p">)</span>
<span class="p">],</span> <span class="k">true</span><span class="p">);</span>
</pre></div>

<p>Each handler can itself be a stack of handlers! You can insert more handlers into a particular handler like you would with the main application. You may think of them as events; each <code>Handler</code> that contains a stack (as opposed to a single function) iterates through all its registered functions (listeners) independently, eventually passing the output to the main application stack. The main stack itself is registered in the container as <code>$app['app.handler']</code>.</p>

<p>Normally, a stack will stop iterating once a response is found in the context. To change this behaviour, you can set the <code>terminate_on_response</code> option to false:</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="p">[</span><span class="s1">'app.handler'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">([</span><span class="s1">'terminate_on_response'</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">]);</span>
</pre></div>

<h3>
<a name="context" class="anchor" href="#context"><span class="octicon octicon-link"></span></a>Context</h3>

<p>See the lavish use of <code>$this</code> in the examples above? That's made possible by the automatic binding of each closure or generator to the <code>Context</code> object. Each time the application handles a request or subrequest, a new context is pushed onto the stack. Handlers and middlewares receive a <code>ContextProxy</code> which saves them the trouble of juggling between different context objects.</p>

<p>The context is a simple container for the <code>Request</code> and <code>Response</code> objects. It also holds the route parameters and the return values from each handler.</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/hello/{name}'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">();</span>
    <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">())</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">(</span><span class="s2">"Hello </span><span class="si">$name</span><span class="s2">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p><code>Context::last</code> holds the return (or yielded) value from the previous handler. This is one way to pass information downstream other than using the application container or request attributes.</p>

<h3>
<a name="middleware" class="anchor" href="#middleware"><span class="octicon octicon-link"></span></a>Middleware</h3>

<p>Middlewares are simply handler functions defined as concrete classes by extending <code>Middleware</code>. The logic goes in <code>Middleware::run</code>. Middlewares have access to all context methods, so the syntax is essentially unchanged:</p>

<div class="highlight highlight-php"><pre><span class="k">class</span> <span class="nc">ResponseTimeMiddleware</span> <span class="k">extends</span> <span class="nx">Durian\Middleware</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">run</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$time</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
        <span class="nx">yield</span><span class="p">;</span>
        <span class="nv">$time</span> <span class="o">=</span> <span class="nb">microtime</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$time</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">headers</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'X-Response-Time'</span><span class="p">,</span> <span class="nv">$time</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Middlewares accept the application container in the constructor</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">before</span><span class="p">(</span><span class="k">new</span> <span class="nx">ResponseTimeMiddleware</span><span class="p">(</span><span class="nv">$app</span><span class="p">));</span>
</pre></div>

<h3>
<a name="handler-injection" class="anchor" href="#handler-injection"><span class="octicon octicon-link"></span></a>Handler Injection</h3>

<p>If a handler function returns another <code>Handler</code> or generator function, it will be inserted into the current position of the execution stack.</p>

<p>In essence, the handler stack is recursively iterated over as a multidimensional array.</p>

<h2>
<a name="routing" class="anchor" href="#routing"><span class="octicon octicon-link"></span></a>Routing</h2>

<p>Instead of the hierarchical routing syntax found in some other microframeworks, we use method chaining. The <code>yield</code> keyword allows us to pass execution to the next matching segment. Upon reaching the end of the chain, the execution flow is passed back to all generators in reverse order. Therefore, code before and after a <code>yield</code> statement will "wrap" subsequent route handlers:</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="p">[</span><span class="s1">'awesome_library'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">share</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">MyAwesomeLibrary</span><span class="p">();</span>
<span class="p">});</span>

<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/hello'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$app</span><span class="p">[</span><span class="s1">'awesome_library'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">performExpensiveOperation</span><span class="p">();</span>
    <span class="nx">yield</span> <span class="s1">'Hello'</span><span class="p">;</span>
    <span class="nv">$app</span><span class="p">[</span><span class="s1">'awesome_library'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">performCleanUp</span><span class="p">();</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/{name}'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">()</span><span class="o">.</span><span class="s1">' '</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">()];</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">()];</span>
<span class="p">});</span>
</pre></div>

<p>Why method chaining? The simple reason is that embedding the next route or method segment inside the route handler function forces us to execute the handler first before proceeding, thus potentially incurring expensive initialization code even if the request results in an error. Here, we stack the handler functions as each segment matches, and execute all of them in one go only if the route and method match is successful.</p>

<p>(At least, that was the original intention. Currently the framework utilizes <a href="https://github.com/nikic/FastRoute">nikic/fast-route</a>, which compiles all the routes into a single regex that maps to handler stack combinations.)</p>

<p>Note that <code>Application::route</code> starts a new segment and returns a new <code>Route</code> object. The method functions map to all the common HTTP request methods (get, post, put, delete, patch, options) and return the same <code>Route</code>. All the routing methods accept an arbitrary number of handler functions, so you can encapsulate surrounding operations (such as the ones in the example above) into a separate generator:</p>

<div class="highlight highlight-php"><pre><span class="nv">$expensiveOperation</span> <span class="o">=</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$app</span><span class="p">[</span><span class="s1">'awesome_library'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">performExpensiveOperation</span><span class="p">();</span>
    <span class="nx">yield</span><span class="p">;</span>
    <span class="nv">$app</span><span class="p">[</span><span class="s1">'awesome_library'</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">performCleanUp</span><span class="p">();</span>
<span class="p">};</span>

<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/hello'</span><span class="p">,</span> <span class="nv">$expensiveOperation</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'Hello'</span><span class="p">;</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="o">...</span><span class="p">);</span>
</pre></div>

<p>You don't necessarily have to chain route segments, the old-fashioned way of defining entire paths will still work fine:</p>

<div class="highlight highlight-php"><pre><span class="c1">// Routes will support GET by default</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/users'</span><span class="p">);</span>

<span class="c1">// Methods can be declared without handlers</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/users/{name}'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">();</span>

<span class="c1">// Declare multiple methods separated by pipe characters</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/users/{name}/friends'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="s1">'GET|POST'</span><span class="p">);</span>
</pre></div>

<h3>
<a name="responsemiddleware" class="anchor" href="#responsemiddleware"><span class="octicon octicon-link"></span></a>ResponseMiddleware</h3>

<p><code>ResponseMiddleware</code> takes care of converting return values to Symfony2 <code>Response</code> objects. Arrays will result in a <code>JsonResponse</code>. You may also manually craft a response:</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/tea'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">(</span><span class="s1">'I\'m a teapot'</span><span class="p">,</span> <span class="mi">418</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>Or throw an exception:</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/404'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Alternatively pass in an exception object as the first parameter</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">'Not Found'</span><span class="p">,</span> <span class="mi">404</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>Returning a HTTP status code also works:</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/fail'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">500</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>

<h3>
<a name="subrequests" class="anchor" href="#subrequests"><span class="octicon octicon-link"></span></a>Subrequests</h3>

<p>Subrequests are performed by calling <code>Application::run</code>:</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/song/{id:[0-9]+}'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">,</span>
        <span class="s1">'artist'</span> <span class="o">=&gt;</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s2">"/artists-by-song/</span><span class="si">$id</span><span class="s2">"</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">()</span>
    <span class="p">];</span>
<span class="p">});</span>
</pre></div>

<p>During a subrequest, <code>$this-&gt;master()</code> will return false.</p>

<p>Thrown exceptions from subrequests are not converted to <code>Response</code> objects; they should be handled in the master request.</p>

<h2>
<a name="exception-handling" class="anchor" href="#exception-handling"><span class="octicon octicon-link"></span></a>Exception Handling</h2>

<p>Whenever an exception is thrown, the application bubbles it up through all the generators in the stack.</p>

<p>This means that you can intercept any exception by wrapping a <code>yield</code> statement with a try/catch block:</p>

<div class="highlight highlight-php"><pre><span class="nv">$exceptionHandlerMiddleware</span> <span class="o">=</span> <span class="nv">$app</span><span class="o">-&gt;</span><span class="na">handler</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">yield</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$exception</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">master</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nv">$exception</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">(</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="mi">500</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p>For pretty exception traces, you can make use of the <a href="https://github.com/filp/whoops">filp/whoops</a> library by including it in your composer.json:</p>

<div class="highlight highlight-json"><pre><span class="p">{</span>
    <span class="nt">"require"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"gigablah/durian"</span><span class="p">:</span> <span class="s2">"~0.1"</span><span class="p">,</span>
        <span class="nt">"filp/whoops"</span><span class="p">:</span> <span class="s2">"~1.0"</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Then, register <code>WhoopsMiddleware</code> as the first handler in your application:</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">before</span><span class="p">(</span><span class="k">new</span> <span class="nx">Durian\Middleware\WhoopsMiddleware</span><span class="p">(</span><span class="nv">$app</span><span class="p">));</span>
</pre></div>

<p>You may also register it for only a specific sub-stack, like the example below:</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">([</span>
    <span class="k">new</span> <span class="nx">Durian\Middleware\ResponseMiddleware</span><span class="p">(</span><span class="nv">$app</span><span class="p">),</span>
    <span class="k">new</span> <span class="nx">Durian\Handler</span><span class="p">([</span>
        <span class="k">new</span> <span class="nx">Durian\Middleware\WhoopsMiddleware</span><span class="p">(</span><span class="nv">$app</span><span class="p">),</span>
        <span class="k">new</span> <span class="nx">Durian\Middleware\RouterMiddleware</span><span class="p">(</span><span class="nv">$app</span><span class="p">)</span>
    <span class="p">])</span>
<span class="p">]);</span>
</pre></div>

<p>Just to drive home the point, you may also register it only for a specific route:</p>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="s1">'/foo'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Durian\Middleware\WhoopsMiddleware</span><span class="p">(</span><span class="nv">$app</span><span class="p">),</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<h2>
<a name="dependency-injection" class="anchor" href="#dependency-injection"><span class="octicon octicon-link"></span></a>Dependency Injection</h2>

<p>Dependency injection? What's that? :)</p>

<p>Other than the fact that the application container is based on <code>Pimple</code>, a lightweight DIC (or service locator, if you're so inclined), no parameter matching is currently performed on route handlers. Eventually I'd like to have it implemented as an optional trait. Watch this space!</p>

<h2>
<a name="httpkernelinterface" class="anchor" href="#httpkernelinterface"><span class="octicon octicon-link"></span></a>HttpKernelInterface</h2>

<p>The <code>Application</code> container implements Symfony2's <code>HttpKernelInterface</code>, so you can compose it with other compatible applications via <a href="http://stackphp.com">Stack</a>.</p>

<h2>
<a name="method-list" class="anchor" href="#method-list"><span class="octicon octicon-link"></span></a>Method List</h2>

<h3>
<a name="application" class="anchor" href="#application"><span class="octicon octicon-link"></span></a>Application</h3>

<div class="highlight highlight-php"><pre><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span> <span class="c1">// handle a request or subrequest</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$path</span><span class="p">);</span> <span class="c1">// handle a HTTP method for a request path</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">handler</span><span class="p">(</span><span class="nv">$callable</span><span class="p">,</span> <span class="nv">$condition</span><span class="p">);</span> <span class="c1">// wrap a callback as a Handler</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">();</span> <span class="c1">// get the handler stack</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">(</span><span class="k">array</span> <span class="nv">$handlers</span><span class="p">,</span> <span class="nv">$replace</span><span class="p">);</span> <span class="c1">// replace or append to the stack</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">before</span><span class="p">(</span><span class="nv">$callable</span><span class="p">,</span> <span class="nv">$condition</span><span class="p">);</span> <span class="c1">// prepend a handler to the stack</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">after</span><span class="p">(</span><span class="nv">$callable</span><span class="p">,</span> <span class="nv">$condition</span><span class="p">);</span> <span class="c1">// append a handler to the stack</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="o">...</span><span class="nv">$handlers</span><span class="p">);</span> <span class="c1">// start a new route segment</span>
<span class="nv">$app</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$type</span><span class="p">,</span> <span class="nv">$catch</span><span class="p">);</span> <span class="c1">// implement HttpKernelInterface::handle</span>
</pre></div>

<h3>
<a name="handler" class="anchor" href="#handler"><span class="octicon octicon-link"></span></a>Handler</h3>

<div class="highlight highlight-php"><pre><span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">();</span> <span class="c1">// iterate through the handler stack</span>
<span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">handler</span><span class="p">(</span><span class="nv">$callable</span><span class="p">,</span> <span class="nv">$condition</span><span class="p">);</span> <span class="c1">// wrap a callback as a Handler</span>
<span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">();</span> <span class="c1">// get the handler stack</span>
<span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">(</span><span class="k">array</span> <span class="nv">$handlers</span><span class="p">,</span> <span class="nv">$replace</span><span class="p">);</span> <span class="c1">// replace or append to the stack</span>
<span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">context</span><span class="p">(</span><span class="nv">$context</span><span class="p">);</span> <span class="c1">// set the HTTP context</span>
<span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">context</span><span class="p">();</span> <span class="c1">// get the HTTP context</span>
<span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">before</span><span class="p">(</span><span class="nv">$callable</span><span class="p">,</span> <span class="nv">$condition</span><span class="p">);</span> <span class="c1">// prepend a handler to the stack</span>
<span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">after</span><span class="p">(</span><span class="nv">$callable</span><span class="p">,</span> <span class="nv">$condition</span><span class="p">);</span> <span class="c1">// append a handler to the stack</span>
<span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">(</span><span class="k">array</span> <span class="nv">$options</span><span class="p">);</span> <span class="c1">// set the handler options</span>
<span class="nv">$handler</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">();</span> <span class="c1">// get the handler options</span>
</pre></div>

<h3>
<a name="route" class="anchor" href="#route"><span class="octicon octicon-link"></span></a>Route</h3>

<div class="highlight highlight-php"><pre><span class="nv">$route</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="o">...</span><span class="nv">$handlers</span><span class="p">);</span> <span class="c1">// append a new route segment</span>
<span class="nv">$route</span><span class="o">-&gt;</span><span class="na">method</span><span class="p">(</span><span class="nv">$methods</span><span class="p">,</span> <span class="o">...</span><span class="nv">$handlers</span><span class="p">);</span> <span class="c1">// register method handler(s)</span>
<span class="nv">$route</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="o">...</span><span class="nv">$handlers</span><span class="p">);</span> <span class="c1">// register method handler(s) for GET</span>
<span class="nv">$route</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="o">...</span><span class="nv">$handlers</span><span class="p">);</span> <span class="c1">// register method handler(s) for POST</span>
<span class="nv">$route</span><span class="o">-&gt;</span><span class="na">put</span><span class="p">(</span><span class="o">...</span><span class="nv">$handlers</span><span class="p">);</span> <span class="c1">// register method handler(s) for PUT</span>
<span class="nv">$route</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="o">...</span><span class="nv">$handlers</span><span class="p">);</span> <span class="c1">// register method handler(s) for DELETE</span>
<span class="nv">$route</span><span class="o">-&gt;</span><span class="na">patch</span><span class="p">(</span><span class="o">...</span><span class="nv">$handlers</span><span class="p">);</span> <span class="c1">// register method handler(s) for PATCH</span>
<span class="nv">$route</span><span class="o">-&gt;</span><span class="na">options</span><span class="p">(</span><span class="o">...</span><span class="nv">$handlers</span><span class="p">);</span> <span class="c1">// register method handler(s) for OPTIONS</span>
<span class="nv">$route</span><span class="o">-&gt;</span><span class="na">head</span><span class="p">(</span><span class="o">...</span><span class="nv">$handlers</span><span class="p">);</span> <span class="c1">// register method handler(s) for HEAD</span>
<span class="nv">$route</span><span class="o">-&gt;</span><span class="na">dump</span><span class="p">();</span> <span class="c1">// recursively dump all routes to an array</span>
</pre></div>

<h3>
<a name="context-1" class="anchor" href="#context-1"><span class="octicon octicon-link"></span></a>Context</h3>

<div class="highlight highlight-php"><pre><span class="nv">$context</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">();</span> <span class="c1">// get the Request</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$type</span><span class="p">);</span> <span class="c1">// set the Request</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">();</span> <span class="c1">// get the Response</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span> <span class="c1">// set the Response</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">(</span><span class="nv">$content</span><span class="p">,</span> <span class="nv">$status</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$headers</span><span class="p">);</span> <span class="c1">// create a new Response</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="nv">$exception</span><span class="p">);</span> <span class="c1">// throw an exception</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="nv">$status</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$headers</span><span class="p">,</span> <span class="nv">$code</span><span class="p">);</span> <span class="c1">// throw an exception</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">master</span><span class="p">();</span> <span class="c1">// check whether the current request is the master request</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span> <span class="c1">// get a route parameter</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$default</span><span class="p">);</span> <span class="c1">// get a route parameter with fallback</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">(</span><span class="k">array</span> <span class="nv">$params</span><span class="p">);</span> <span class="c1">// insert route parameters</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">();</span> <span class="c1">// get all route parameters</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">append</span><span class="p">(</span><span class="nv">$output</span><span class="p">);</span> <span class="c1">// append a handler return value</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">();</span> <span class="c1">// get the last handler return value</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">clear</span><span class="p">();</span> <span class="c1">// clear the current context</span>
</pre></div>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>Released under the MIT license. See the LICENSE file for details.</p>

<h2>
<a name="credits" class="anchor" href="#credits"><span class="octicon octicon-link"></span></a>Credits</h2>

<p>This project was inspired by the following:</p>

<ul>
<li><a href="https://github.com/koajs/koa">koa</a></li>
<li><a href="https://github.com/codegangsta/martini">Martini</a></li>
<li><a href="https://github.com/vlucas/bulletphp">Bullet</a></li>
<li><a href="https://github.com/codeguy/Slim">Slim</a></li>
<li><a href="https://github.com/silexphp/Silex">Silex</a></li>
</ul>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Durian maintained by <a href="https://github.com/gigablah">gigablah</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-48397169-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
